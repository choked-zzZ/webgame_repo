<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>悟嗔游戏</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(45deg, #8B4513, #A0522D);
            font-family: 'Arial', sans-serif;
            color: white;
            overflow: hidden;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to right, #D2691E, #CD853F, #DEB887);
        }

        .grid-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(139,69,19,0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(139,69,19,0.3) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .stats {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #4ecdc4;
        }

        .stat {
            margin: 5px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .wu {
            color: #4ecdc4;
        }

        .chen {
            color: #e74c3c;
        }

        .player {
            position: absolute;
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #f39c12, #e67e22);
            border: 2px solid #d35400;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.6);
        }

        .bullet {
            position: absolute;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            transition: none;
        }

        .bullet.white {
            background: radial-gradient(circle, #ffffff, #ecf0f1);
            border: 2px solid #bdc3c7;
            box-shadow: 0 0 8px rgba(255,255,255,0.5);
        }

        .bullet.black {
            background: radial-gradient(circle, #2c3e50, #34495e);
            border: 2px solid #1a252f;
            box-shadow: 0 0 8px rgba(44,62,80,0.8);
        }

        .obstacle {
            position: absolute;
            width: 40px;
            background: linear-gradient(45deg, #7f8c8d, #95a5a6);
            border: 2px solid #5d6d7e;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(127, 140, 141, 0.4);
        }

        .hole {
            position: absolute;
            width: 120px;
            height: 150px;
            background: radial-gradient(ellipse, #000000, #1a1a1a);
            border: 3px solid #2c3e50;
            border-radius: 60px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.9), 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .message {
            position: absolute;
            left: 50px;
            background: rgba(0,0,0,0.8);
            padding: 10px 15px;
            border-radius: 20px;
            border: 2px solid;
            max-width: 200px;
            font-size: 14px;
            animation: messageSlide 0.5s ease-out;
            z-index: 50;
        }

        .message.wu {
            border-color: #4ecdc4;
            color: #4ecdc4;
        }

        .message.chen {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        @keyframes messageSlide {
            from {
                transform: translateX(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #95a5a6;
            font-size: 14px;
        }

        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-over-content {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #e74c3c;
            text-align: center;
            max-width: 600px;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.5);
        }

        .game-over h2 {
            color: #e74c3c;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .game-over p {
            line-height: 1.6;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .restart-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .restart-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="grid-background"></div>
        
        <!-- 背景音乐 -->
        <audio id="bgMusic" loop preload="auto">
            <source src="background-music.mp3" type="audio/mpeg">
            您的浏览器不支持音频播放
        </audio>
        
        <div class="stats">
            <div class="stat wu">悟: <span id="wu-score">0</span></div>
            <div class="stat chen">嗔: <span id="chen-score">0</span></div>
        </div>

        <div class="player" id="player"></div>

        <div class="instructions">
            <div>W/S: 上下移动</div>
            <div>空格: 发射棋子</div>
            <div>进洞+8悟，被挡/偏离+4嗔</div>
            <div style="color: #4ecdc4;">悟达到100通关</div>
            <div style="color: #e74c3c;">嗔达到100失败</div>
            <div style="color: #f39c12; margin-top: 5px;">点击开始播放音乐</div>
        </div>

        <div class="game-over" id="game-over">
            <div class="game-over-content">
                <h2>游戏结束</h2>
                <p id="ending-text"></p>
                <div id="ending-buttons"></div>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        let gameState = {
            wu: 0,
            chen: 0,
            isWhiteTurn: true,
            lastShotTime: 0,
            gameOver: false,
            musicStarted: false,
            gameLoopRunning: false
        };

        // 背景音乐控制
        const bgMusic = document.getElementById('bgMusic');
        bgMusic.volume = 0.3;

        function startMusic() {
            if (!gameState.musicStarted) {
                bgMusic.play().catch(e => {
                    console.log('音乐文件未找到或播放失败，游戏继续运行');
                });
                gameState.musicStarted = true;
            }
        }

        // 游戏元素
        const player = document.getElementById('player');
        const gameContainer = document.querySelector('.game-container');
        let playerY = window.innerHeight / 2;
        let bullets = [];
        let obstacles = [];
        let holes = [];
        let messages = [];

        // 悟的正面消息
        const wuMessages = [
            "也许你是对的",
            "让我好好想想",
            "我明白了",
            "谢谢你的提醒",
            "这个角度很有趣",
            "受教了"
        ];

        // 嗔的负面消息
        const chenMessages = [
            "够了！别说了！",
            "你根本就不理解我！",
            "闭嘴！",
            "我不想听！",
            "你说的都是废话！",
            "滚开！"
        ];

        // 键盘控制
        const keys = {};
        
        document.addEventListener('keydown', (e) => {
            if (gameState.gameOver) return;
            
            keys[e.key.toLowerCase()] = true;
            
            // 第一次按键时启动音乐
            startMusic();
            
            if (e.code === 'Space') {
                e.preventDefault();
                shootBullet();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        // 玩家移动
        function updatePlayer() {
            if (gameState.gameOver) return;
            
            if (keys['w'] && playerY > 20) {
                playerY -= 3;
            }
            if (keys['s'] && playerY < window.innerHeight - 20) {
                playerY += 3;
            }
            player.style.top = playerY + 'px';
        }

        // 发射子弹
        function shootBullet() {
            if (gameState.gameOver) return;
            
            const now = Date.now();
            if (now - gameState.lastShotTime < 1000) return; // 1秒冷却
            
            gameState.lastShotTime = now;
            
            const bullet = document.createElement('div');
            bullet.className = `bullet ${gameState.isWhiteTurn ? 'white' : 'black'}`;
            bullet.style.left = '70px';
            bullet.style.top = (playerY - 12) + 'px';
            
            gameContainer.appendChild(bullet);
            bullets.push({
                element: bullet,
                x: 70,
                y: playerY - 12,
                isWhite: gameState.isWhiteTurn
            });
            
            gameState.isWhiteTurn = !gameState.isWhiteTurn;
        }

        // 创建障碍物
        function createObstacle() {
            const obstacle = document.createElement('div');
            obstacle.className = 'obstacle';
            
            const height = 100 + Math.random() * 150;
            const x = window.innerWidth - 200;
            const y = Math.random() * (window.innerHeight - height - 100) + 50;
            
            obstacle.style.left = x + 'px';
            obstacle.style.top = y + 'px';
            obstacle.style.height = height + 'px';
            
            gameContainer.appendChild(obstacle);
            obstacles.push({
                element: obstacle,
                x: x,
                y: y,
                width: 40,
                height: height,
                speed: 1 + Math.random() * 2,
                direction: Math.random() > 0.5 ? 1 : -1
            });
        }

        function createHole() {
            const hole = document.createElement('div');
            hole.className = 'hole';
            
            const x = window.innerWidth - 120;
            const y = Math.random() * (window.innerHeight - 250) + 100;
            
            hole.style.left = x + 'px';
            hole.style.top = y + 'px';
            
            gameContainer.appendChild(hole);
            holes.push({
                element: hole,
                x: x,
                y: y,
                width: 120,
                height: 150,
                speed: 0.8 + Math.random() * 1.5,
                direction: Math.random() > 0.5 ? 1 : -1
            });
        }

        // 显示消息
        function showMessage(text, type) {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            
            const randomX = Math.random() * 100 + 50;
            const randomY = Math.random() * 300 + 100;
            
            message.style.left = randomX + 'px';
            message.style.top = randomY + 'px';
            
            gameContainer.appendChild(message);
            messages.push(message);
            
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
                const index = messages.indexOf(message);
                if (index > -1) {
                    messages.splice(index, 1);
                }
            }, 3000);
        }

        // 碰撞检测
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // 更新分数
        function updateScore(type, points) {
            gameState[type] += points;
            document.getElementById(`${type}-score`).textContent = gameState[type];
            
            if (type === 'wu') {
                showMessage(wuMessages[Math.floor(Math.random() * wuMessages.length)], 'wu');
            } else {
                showMessage(chenMessages[Math.floor(Math.random() * chenMessages.length)], 'chen');
            }
            
            // 检查游戏结束条件
            if (gameState.chen >= 100) {
                gameOver('chen');
            } else if (gameState.wu >= 100) {
                gameOver('wu');
            }
        }

        // 游戏结束
        function gameOver(reason) {
            gameState.gameOver = true;
            gameState.gameLoopRunning = false;
            
            const gameOverDiv = document.getElementById('game-over');
            const titleElement = gameOverDiv.querySelector('h2');
            const textElement = document.getElementById('ending-text');
            const buttonsElement = document.getElementById('ending-buttons');
            
            if (reason === 'chen') {
                titleElement.textContent = '焚琴煮鹤亦自焚';
                titleElement.style.color = '#e74c3c';
                textElement.textContent = '他的世界被围棋所围绕，每一步都在追求无尽的胜利，心中不容忍一丝的失败与妥协。他的执着如同烈火，烧尽了他与亲人朋友之间的关系。他临终前才终于意识到，自己已经失去了所有。孤独与痛苦成了他唯一的陪伴，而那份对围棋的极度渴望，也早已让他陷入了无法自拔的深渊。';
                buttonsElement.innerHTML = '<button class="restart-btn" onclick="restartGame()">重新开始</button>';
            } else if (reason === 'wu') {
                titleElement.textContent = '心如止水，智慧圆满';
                titleElement.style.color = '#4ecdc4';
                textElement.textContent = '经过无数次的思辨与包容，你终于达到了内心的平静。每一次的理解与宽容，都让你更接近真理的本质。此刻，你已经准备好面对更深层的挑战...';
                buttonsElement.innerHTML = `
                    <button class="restart-btn" onclick="continueStory()" style="background: linear-gradient(45deg, #4ecdc4, #45b7aa);">继续旅程</button>
                    <button class="restart-btn" onclick="restartGame()" style="margin-left: 10px;">重新开始</button>
                `;
            }
            
            gameOverDiv.style.display = 'flex';
        }
        
        // 继续剧情的钩子函数
        function continueStory() {
            console.log('触发通关节点：悟达到100');
            
            const gameData = {
                finalWu: gameState.wu,
                finalChen: gameState.chen,
                completionType: 'victory_wu_100'
            };
            
            alert(`通关数据已准备：悟=${gameData.finalWu}, 嗔=${gameData.finalChen}\n可在此接入后续剧情！`);
        }

        // 重新开始游戏
        function restartGame() {
            // 重置游戏状态
            gameState = {
                wu: 0,
                chen: 0,
                isWhiteTurn: true,
                lastShotTime: 0,
                gameOver: false,
                musicStarted: gameState.musicStarted,
                gameLoopRunning: false
            };
            
            // 清理所有游戏元素
            bullets.forEach(bullet => {
                if (bullet.element && bullet.element.parentNode) {
                    bullet.element.remove();
                }
            });
            obstacles.forEach(obstacle => {
                if (obstacle.element && obstacle.element.parentNode) {
                    obstacle.element.remove();
                }
            });
            holes.forEach(hole => {
                if (hole.element && hole.element.parentNode) {
                    hole.element.remove();
                }
            });
            messages.forEach(message => {
                if (message && message.parentNode) {
                    message.remove();
                }
            });
            
            // 重置数组
            bullets = [];
            obstacles = [];
            holes = [];
            messages = [];
            
            // 重置显示
            document.getElementById('wu-score').textContent = '0';
            document.getElementById('chen-score').textContent = '0';
            document.getElementById('game-over').style.display = 'none';
            
            // 重置玩家位置
            playerY = window.innerHeight / 2;
            player.style.top = playerY + 'px';
            
            // 重新初始化游戏
            setTimeout(() => {
                initGame();
            }, 100);
        }

        // 游戏循环
        function gameLoop() {
            if (gameState.gameOver || !gameState.gameLoopRunning) return;
            
            updatePlayer();
            
            // 更新子弹
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += 6;
                bullet.element.style.left = bullet.x + 'px';
                
                // 子弹超出屏幕
                if (bullet.x > window.innerWidth) {
                    bullet.element.remove();
                    bullets.splice(i, 1);
                    updateScore('chen', 4);
                    continue;
                }
                
                // 检查与障碍物碰撞
                let bulletHit = false;
                for (let j = 0; j < obstacles.length; j++) {
                    const obstacle = obstacles[j];
                    if (checkCollision(
                        {x: bullet.x, y: bullet.y, width: 25, height: 25},
                        {x: obstacle.x, y: obstacle.y, width: obstacle.width, height: obstacle.height}
                    )) {
                        bullet.element.remove();
                        bullets.splice(i, 1);
                        updateScore('chen', 4);
                        bulletHit = true;
                        break;
                    }
                }
                
                if (bulletHit) continue;
                
                // 检查与洞的碰撞
                for (let j = 0; j < holes.length; j++) {
                    const hole = holes[j];
                    if (checkCollision(
                        {x: bullet.x, y: bullet.y, width: 25, height: 25},
                        {x: hole.x, y: hole.y, width: hole.width, height: hole.height}
                    )) {
                        bullet.element.remove();
                        bullets.splice(i, 1);
                        updateScore('wu', 8);
                        break;
                    }
                }
            }
            
            // 更新障碍物
            obstacles.forEach((obstacle) => {
                obstacle.y += obstacle.speed * obstacle.direction;
                
                if (obstacle.y <= 0 || obstacle.y >= window.innerHeight - obstacle.height) {
                    obstacle.direction *= -1;
                }
                
                obstacle.element.style.top = obstacle.y + 'px';
            });
            
            // 更新洞
            holes.forEach((hole) => {
                hole.y += hole.speed * hole.direction;
                
                if (hole.y <= 0 || hole.y >= window.innerHeight - hole.height) {
                    hole.direction *= -1;
                }
                
                hole.element.style.top = hole.y + 'px';
            });
            
            if (gameState.gameLoopRunning && !gameState.gameOver) {
                requestAnimationFrame(gameLoop);
            }
        }

        // 初始化游戏
        function initGame() {
            // 重置玩家位置
            playerY = window.innerHeight / 2;
            player.style.top = playerY + 'px';
            
            // 创建初始元素
            createHole();
            createHole();
            createObstacle();
            
            // 启动游戏循环
            if (!gameState.gameLoopRunning) {
                gameState.gameLoopRunning = true;
                gameLoop();
            }
        }

        // 启动游戏
        window.addEventListener('load', () => {
            initGame();
        });
        
        // 点击开始音乐
        document.addEventListener('click', startMusic);
    </script>
</body>
</html>